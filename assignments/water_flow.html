<h2>Geospatial simulations of dynamic processes: water flow</h2>

<h3>Outline:</h3>
<ul>
    <li> to update the 2013 DEM to 2015 state of terrain, perform smooth fusion of lidar and UAS data
    <li> run simulation of surface water flow using path sampling technique on the following DSMs:
         lidar DEM, UAS DSM, fused lidar+UAS 
    <li>optional: assess impact of changes in topography and landuse on water flow pattern and dynamics
    <li> visualize your results using animations
</ul>

<p>
<h3>Data:</h3> use the data from previous assignment, see the <a href="../assignments.html">Assignments web page</a>
and sparse point clouds for the targeted area from 5 flights in 2015: <a href="https://drive.google.com/open?id=0B1AfQGDB8tPXUzJCVER1TW0zTVU">March (03)</a>, <a href="https://drive.google.com/open?id=0B1AfQGDB8tPXSFM1MWVtbE9GNEE">June (06)</a>, <a href="https://drive.google.com/open?id=0B1AfQGDB8tPXdnJZSHFsQTVLLXc">September (09)</a>, O<a href="https://drive.google.com/open?id=0B1AfQGDB8tPXSnpZVnVmdl9wTjg">October 6th (10)</a> and <a href="https://drive.google.com/open?id=0B1AfQGDB8tPXU0ZoVXZSLUhQekU">October 29th (11)</a>

<p>
<h3>Workflow overview</h3>
<p>
Smooth Fusion
<ul>
  <li>Use binning to create a 0.2m resolution DEM from lidar for entire area and a DSM from UAV for the region 
      area to be updated. (r.in.lidar), the rasters will have holes but that is OK
  <li>use map algebra to replace all cells in UAV DSM that fall more than 0.5m below lidar DEM with nulls
      - these are errors that we have observed in the area with trees with points over 10m below the surface
  <li>use map algebra to replace the lidar data in the fields (use the fields mask) by UAV data 
      in the binned DEM: you can patch them exactly at the boundary or leave a narrow band of no-data
  <li> create smooth DEM based on the combined raster with holes to points (select one of the options
       provided bellow)
  <ul>
      <li>reinterpolate the raster with holes with r.fill.nulls
      <li>export the raster as points or convert it to points and interpolate the smooth raster using v.surf.rst
       - r.out.xyz may be the easiest, r.to.vect may work too
      <li>randomly sample the combined DEM with output as 3D vector points and interpolate the smooth raster using v.surf.rst
  </ul>
</ul>
<p>
Surface water flow modeling
<ul>
  <li>run r.watershed to identify watershed boundaries to make sure you run the simulations in area with at least one complete watershed
  <li>select subregion with a watershed and run path sampling based simulation of water flow (r.sim.water) 
      using the lidar DEM, UAV DSM and the fused DEM (lidar updated with UAS data).
  <li>create animation for the results, discuss differences
  <li>select additional UAS DSM from our time series and run water flow simulation, evaluate for change in flow patterns
</ul>
<p>
Optional: Management and analysis of multitemporal data
<p>
Register our UAV DSM as time series, and use the t* commands to perform temporal analysis 

<h3>Workflow in GRASS71</h3>

<p><b>Smooth fusion</b>

<p>
Import binned lidar for entire area
<pre><code>
g.region rast=mid_pines_lidar2013_dsm res=0.2 -p
r.in.lidar -o input=mid_pines_spm_2013.las out=midpines_lidar_02m
</code></pre>

Import binned UAV for subarea to be updated, first find the las extent, 
it will be n=219660.060000 s=219288.850000 e=637287.080000 w=636876.930000 b=84.000000 t=139.680000
then set the region
<pre><code>
r.in.lidar -go input=2015_06_sample_points_NCspm.las out=midpines_uav_06_02m_raw
g.region n=219660.060000 s=219288.850000 e=637287.080000 w=636876.930000 res=0.2 -p
r.in.lidar -o input=2015_06_sample_points_NCspm.las out=midpines_uav_06_02m_raw
</code></pre>

Replace all cells in UAV DSM that fall more than 0.5m below lidar DEM with nulls
TODO! but make sure lidar nulls do not overwrite you uav data
<pre><code>
r.mapcalc "midpines_uav_06_02m_fixed = if(midpines_uav_06_02m_raw-0.3 < midpines_lidar_02m, null(), midpines_uav_06_02m_raw)" 
</code></pre>

">Set the region back to entire area and patch the binned DEMs together
<pre><code>
g.region rast=mid_pines_lidar2013_dsm res=0.2 -p 
r.mapcalc 
</code></pre>

<!--
Then, within this region, we compute a raster with lidar+uas DSM average in the overlap and UAS elsehwere
<pre><code>
r.mapcalc "lid_uas_overlap_avg = if(isnull(2015_06_20_DSM_agi_11GCP_cl),(2015_06_20_DSM_agi_11GCP+mid_pines_lidar2013_dsm)/2.,2015_06_20_DSM_agi_11GCP_cl)"
</code></pre>

We can now merge it with lidar for entire study area and check the patch edges using shaded relief
<pre><code>
g.region rast=mid_pines_lidar2013_dsm
r.mapcalc "lidar_uas_mergedavg = if(isnull(lid_uas_overlap_avg), mid_pines_lidar2013_dsm, lid_uas_overlap_avg)"
r.relief lidar_uas_mergedavg out=lidar_uas_mergedavgsh
-->
<p><b>Water flow simulation from past MEA792: MultiD modeling</b></p>

<a href="r_sim_water.html">Instructions for the time series of UAV data</a>
<p>
compute spatial pattern of overland flow depth and discharge<br>
compute input raster maps for uniform land cover and uniform rainfall excess<br>

<pre><code>
g.region rural_1m res=2 -p
r.mapcalc "man05 = 0.05"
r.mapcalc "infil0 = 0."
r.mapcalc "rain50mmhr = 50."
</code></pre>

<p>
calculate partial derivatives to define the gradient of elevation surface<br>

<pre><code>
v.surf.rst -d in=elev_lid792_bepts elev=elev_lid792_2m slop=dx_2m asp=dy_2m ten=15 smooth=1.5 npmin=150
</code></pre>

<p>
run the model<br>
remove backslashes when running from GUI command console<br>

<pre><code>
r.sim.water -t elev=elev_lid792_2m dx=dx_2m dy=dy_2m rain=rain50mmhr infil=infil0 man=man05 \
          depth=wdp_2m disch=disch_2m nwalk=400000 niter=25 outit=1 hmax=0.2 halpha=8.0 hbeta=1.0
d.rast wdp_2m.020
d.rast disch_2m.020
</code></pre>

<p>
animate the time series File > Animation tool<br>


<p>
Compute runoff for spatially variable landcover
represented by  spatially variable Mannings and infiltration variable Mannings
(<a href="http://courses.ncsu.edu/gis582/common/grass/data/lu_labels.txt">lu_labels.txt</a>).

<pre><code>
r.recode landcover_1m out=mancover_2m
</code></pre>

<pre><code>
1:1:0.9:0.9
2:2:0.5:0.5
3:3:0.01:0.01
4:4:0.03:0.03
5:5:0.01:0.01
6:6:0.05:0.05
7:7:0.1:0.1
8:8:0.1:0.1
9:9:0.9:0.9
10:10:0.03:0.03
11:11:0.5:0.5
</code></pre>

<p>
variable rainfall excess (rainfall intensity - infitration rate)<br>

<pre><code>
r.recode landcover_1m out=raincover_2m
</code></pre>

<pre><code>
1:1:50:50
2:2:5:5
3:3:40:40
4:4:35:35
5:5:50:50
6:6:40:40
7:7:25:25
8:8:15:15
9:9:50.:50.
10:10:40:40 
11:11:10:10 
</code></pre>

<p>
run the model<br>

<pre><code>
r.sim.water -t elev=elev_lid792_2m dx=dxdemstr_2m dy=dydemstr_2m rain=raincover_2m infil=infil0 \
               man=mancover_2m depth=wdpstrcov_2m disch=distrcov_2m nwalk=400000 niter=25 outit=1 \
               hmax=0.2 halpha=8.0 hbeta=1.0
d.rast wdpstrcov_2m.20
d.legend wdpstrcov_2m.20
d.rast distrcov_2m.20
d.legend distrcov_2m.20 
</code></pre>

<P>Simulations for the Centennial Campus
</code></pre>

<p>
save the provided cc_south MAPSET in the nc_spm_08_grass7 directory<br>
Using the 2001, 3m resolution NED LE_ned_3m<br>
perform watershed analysis (flowaccumulation and watershed boundaries),<br>
generate countours in a subregion<br>

<pre><code>
g.region lakeraleigh_3m -p
r.watershed LR_ned_3m accum=LR_accum basin=LR_basin thre=10000
g.region lakeraleighzm_3m -p
r.contour LR_ned_3m out=LR_ned_3m_cont2 step=2
</code></pre>

<p>
analyze overland flow for the years 2001<br>
TODO - ADD NEW DEM for comparison!!!<br>
compare results for the reprojected USGS LR_ned_3m and lidar-based DEM<br>
prepare uniform input and run simwe, show the impact of Mannings on the result<br>
use rain parameter to provide raifall excess (rainfall-infiltration)<br>
use infil parameter to simulate infiltration of flowing water (flow-infiltration)<br>

<pre><code>
r.mapcalc "man015 = 0.15"
r.mapcalc "man005 = 0.05"
r.mapcalc "infil0 = 0."
r.mapcalc "rain25mmhr = 25"
r.slope.aspect LR_ned_3m dx=ned3m_dx dy=ned3m_dy
r.sim.water -t elev=LR_ned_3m dx=ned3m_dx dy=ned3m_dy rain=rain25mmhr infil=infil0 man=man015 \
depth=nedwdp_3m_n015 disch=nedisch_3m_n015 nwalk=100000 niter=30 outit=1 hmax=0.2 halpha=8.0 hbeta=1.0 --o
r.sim.water -t elev=LR_ned_3m dx=ned3m_dx dy=ned3m_dy rain=rain25mmhr infil=infil0 man=man005 \
depth=nedwdp_3m_n005 disch=nedisch_3m_n005 nwalk=100000 niter=30 outit=1 hmax=0.2 halpha=8.0 hbeta=1.0 --o
</code></pre>

<p>
if the data set has 2013 DEM perform the same analysis and compare the results<br>
<!--
#output and animate the particles
r.sim.water -t elev=elev_rand3m dx=dx_3m dy=dy_3m rain=rain25mmhr infil=infil0 man=man0.15 \
disch=tdisch_3mn1 outwalk=lr_walk nwalk=100000 niter=30 outit=2 hmax=0.2 halpha=8.0 hbeta=1.0
-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>GIS595-004/603; MEA592-006/601:<br>UAS Mapping for 3D Modeling</title>

<link rel="shortcut icon" href=".././img/favicon.ico" />

<link href="../layout.css" rel="stylesheet" type="text/css" media="screen">
<link href="../style.css" rel="stylesheet" type="text/css" media="screen">

</head>

<body>

<div id="outercontainer">
<div id="container">

<header>
<div id="header-image">
    <h1>GIS595-004/603; MEA592-006/601:<br>UAS Mapping for 3D Modeling</h1>
</div>

<nav>
<ul class="nav">
<li><a href="../index.html">Syllabus</a></li>
<li><a href="../schedule.html">Schedule</a></li>
<li><a href="../logistics.html">Course logistics</a></li>
<li><a href="../topics.html">Topics</a></li>
<!--<li><a href="../lectures.html">Lectures</a></li>-->
<li><a href="../projects.html">Projects</a></li>
<li><a href="../workshop.html">Workshop</a></li>
</ul>
</nav>

</header>

<main>
<!-- This is a generated file. Do not edit. -->
<h2>Fusion of uas and lidar data</h2>

Outline:
<ul>
    <li>analyze the differences between the lidar (2013, 2015 surveys) and UAS DEM/DSM
    <li>fuse selected lidar and UAS DSM
    <li>evaluate impact of fusion technique on water flow simulation
</ul>

Data: 
<ul>
    <li>you should already have both the lidar and uas DSMs and points clouds, get anything missing
        from the <a href="../assignments.html">Course logistics web page</a>.
    <li><a href="./resources/fields.pack">Fields polygon as packed raster</a> use r.unpack in your mapset to import it
</ul>
<p>
Tools:
<ul>
    <li>
        Your <a href="http://wingrass.fsv.cvut.cz/grass70/">GRASS GIS 7</a>
        installation should also include <a href="http://www.liblas.org/">libLAS</a> library
        which is used by GRASS modules v.in.lidar and r.in.lidar
        (standalone GRASS GIS for MS Windows, OSGeo4W and Ubuntu packages contain libLAS).
    </li>
    <li>libLAS installation should include command line tools lasinfo and las2txt.
</ul>

<!-- cleanup the description of workflows, keep only necessary/interesting parts, add the relevant parts from water_flow.html-->

<h3>Analyze the difference between the lidar and UAS DSM </h3>

Workflow overview:

First we need to evaluate the DSMs to find out which are suitable for fusion
<ul>
 <li> compute the difference between a selected lidar DSM and selected UAS DSMs: 
      entire raster,  along a stable linear feature (road and roof)
 <li> use the results to evaluate whether there is a significant systematic error, such as vertical shift in profiles
along the road
 <li> use the raster differences to identify distortions, look for unexpected patterns, verify with profile,
and exclude distorted areas from study area.
 <li> you have two DSMs: lidar DSM and a low-distortion subset of UAS DSM:
      create a new DSM for the entire area using at least two approaches
      and compare how the two approaches work for water flow modeling
</ul>

Suggested color table for differences, used in the workflow as 
<a href="./resources/dif_lidar_uav.txt">dif_lidar_uav.txt</a>:

<pre data-filename="dif_lidar_uav.txt"><code> -40 red
 -1 orange
 -0.5 yellow
 -0.1 grey
 0 white
 0.1 grey
 0.5 cyan
 1 aqua
 35 blue
</code></pre>

Compute the differences between the lidar and UAS DSMs and evaluate their spatial distribution and
summary statistical properties
<pre><code>g.region rast=mid_pines_lidar2013_dsm -p
r.mapcalc "diff_lidardsm_agi_june = mid_pines_lidar2013_dsm - 2015_06_20_DSM_agi_11GCP"
r.colors diff_lidardsm_agi_june rules=dif_lidar_uav.txt
r.univar diff_lidardsm_agi_june
r.mapcalc "diff_lidardsm_pix4d_june = mid_pines_lidar2013_dsm - 2015_06_20_pix4d_11GCP_dsm"
r.colors diff_lidardsm_pix4d_june rules=dif_lidar_uav.txt
r.univar diff_lidardsm_pix4d_june
</code></pre>

Evaluate possible systematic shift along stable features using the profile tool or the following commands
<pre><code>r.profile -g input=diff_lidardsm_agi_june output=road.txt coordinates=637208,219491,637059,219734
v.in.ascii input=road.txt output=profile_road separator=space columns="x double,y double,profile double,diff double"
v.univar map=profile_road column=diff
</code></pre>

hy are the distortions / errors low along the road but high in the fields?
Because the shift in the lidar and UAS DSM is small we will ignore it in our first set of fusion examples, but we will
use the analysis above top select the region with minimal distortion in the UAS DSM and compute clipped DSM

<pre><code>g.region n=219720.9 s=219257.1 w=636762.9 e=637190.4 res=0.3 -p
r.mapcalc "2015_06_20_DSM_agi_11GCP_cl = 2015_06_20_DSM_agi_11GCP"
</code></pre>

<h3>Patch and fuse the lidar and UAS DSM </h3>
<!-- remove the part with simple average: replace with smooth fusion-->

Patch UAS DSM with lidar DSM to cover the entire Mid Pines study area and use shaded relief 
to check for patch edges

<pre><code>g.region rast=mid_pines_lidar2013_dsm -p
r.patch 2015_06_20_DSM_agi_11GCP_cl,mid_pines_lidar2013_dsm out=lid_uas_patch
r.relief lid_uas_patch out=lid_uas_patchsh
</code></pre>

We have visible discontinuity along the patch edges so we will use map algebra to do
the patching with averaged overlap.
First we define a region for 6m (20 cell) overlap (you can do this also interactively using mouse)
<pre><code>g.region rast=2015_06_20_DSM_agi_11GCP_cl -p
g.region s=s-6 n=n+6 e=e+6 w=w-6 -p 
</code></pre>

Then, within this region, we compute a raster with lidar+uas DSM average in the overlap and UAS elsehwere
<pre><code>r.mapcalc "lid_uas_overlap_avg = if(isnull(2015_06_20_DSM_agi_11GCP_cl),(2015_06_20_DSM_agi_11GCP+mid_pines_lidar2013_dsm)/2.,2015_06_20_DSM_agi_11GCP_cl)"
</code></pre>

We can now merge it with lidar for entire study area and check the patch edges using shaded relief
<pre><code>g.region rast=mid_pines_lidar2013_dsm
r.mapcalc "lidar_uas_mergedavg = if(isnull(lid_uas_overlap_avg), mid_pines_lidar2013_dsm, lid_uas_overlap_avg)"
r.relief lidar_uas_mergedavg out=lidar_uas_mergedavgsh
</code></pre>
<p>
We now have smoother transition from UAS to lidar, but you can still identify two edges when viewing the patched DSM
in 3D view (nviz). Therefore we will use weighted average to smooth out the overlap with the following workflow
(try to explain it in your report):

<pre><code>g.region rast=2015_06_20_DSM_agi_11GCP_cl -p
g.region s=s+10 n=n-10 e=e-10 w=w+10 -p
r.mapcalc "dummy = 1"
g.region rast=2015_06_20_DSM_agi_11GCP_cl -p
r.grow.distance -m input=dummy distance=distance
g.region rast=mid_pines_lidar2013_dsm
r.mapcalc "patched_smooth = if(isnull(distance), mid_pines_lidar2013_dsm, (1 - distance/10.) * 2015_06_20_DSM_agi_11GCP_cl +(distance/10) * mid_pines_lidar2013_dsm)"
</code></pre>

We will now create a smooth transition  with spatially variable overlap

<!-- move the relevant part for the smooth fusion here -->

<h3>Compare surface flow pattern on patched and fused DSMs </h3>
The aim of the processing is to investigate the flow pattern
simulated on different DSMs.
The lidar 2013 and the timeseries of UAS-based DSMs will be used as input for simulations
using <a href="https://grass.osgeo.org/grass70/manuals/r.sim.water.html">r.sim.water</a>.

First, we examine the watershed boundaries to see which area to include:
<pre><code>r.watershed elevation=merged_lidar_uav_full threshold=50000 accumulation=merged_flowacc basin=merged_basin
r.to.vect -t input=merged_basin output=merged_basin type=area
</code></pre>

<p> We will compute water flow on our fused DEM within our selected region.
We need first order spatial derivatives which can be derived either
using <a href="https://grass.osgeo.org/grass70/manuals/r.slope.aspect.html">r.slope.aspect</a>
or during interpolation phase with <a href="https://grass.osgeo.org/grass70/manuals/v.surf.rst.html">v.surf.rst</a>.

<pre><code>g.region n=219727 s=219319 e=637191 w=636701 res=0.3 -p
r.slope.aspect elevation=merged_lidar_uav_full dx=merged_dx dy=merged_dy
</code></pre>
The simulation writes water depth and discharge raster maps
so we can look at first results soon although the simulation takes a lot of time.
Depending on your processing power, you can make the region smaller.
<pre><code>r.sim.water -t elevation=merged_lidar_uav_full dx=merged_dx dy=merged_dy rain_value=30 man_value=0.15 depth=merged_depth discharge=merged_disch nwalkers=100000 niterations=20 output_step=1 hmax=0.2 halpha=8.0 hbeta=1.0
</code></pre>

<h4>Animation and visualisation the results</h4>
Animation tool allows to create animated gifs from a series of raster maps.
Load all the *_depth maps to the animation tool.
Export the animation as GIF file.

You can use <a href="http://www.imagemagick.org/script/index.php">ImageMagick</a>
to add a pause in the end of the simulation:
<pre><code>convert animation.gif \( +clone -set delay 300 \) animation_with_pause.gif
</code></pre>

<p>The water flow pattern is better visible in 2d when it's draped over a shaded relief.
<pre><code>d.shade shade=merged_lidar_uav_full_relief color=merged_depth.20 brighten=30
</code></pre>
You can also use shaded maps in the animation tool.


</main>

<footer>

<nav>
<ul>
<li><a class="term-changes" href="https://moodle-courses1718.wolfware.ncsu.edu/course/view.php?id=4709">Moodle site</a></li>
<li><a href="http://help.ncsu.edu/">Computing Help</a></li>
<li><a href="http://geospatial.ncsu.edu/">GIST Home</a></li>
<li><a href="http://www.ncsu.edu/policies/prr-disclaimer.php">Disclaimer</a></li>
<li><a href="http://oit.ncsu.edu/itaccess">Accessibility</a></li>
<li><a href="https://github.com/ncsu-geoforall-lab/uav-lidar-analytics-course" title="Source code for web pages on GitHub">
        <img src="../img/github_logo.png" alt="GitHub Octocat logo">
    </a>
</li>
<li title="Copyright and license (not applicable to linked materials)">
    &copy; 2018
    <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
    <a href="http://geospatial.ncsu.edu/osgeorel/">NCSU GeoForAll Lab</a>
</li>
</ul>
</nav>

</footer>

</div>
</div>

</body>
</html>
